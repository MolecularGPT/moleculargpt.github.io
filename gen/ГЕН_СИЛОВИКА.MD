# «Ген Силовика» — шаблон исследования (папки + файлы)

> Назначение: **научная проверка гипотез** о стресс‑реактивности/восстановлении и связанных биомаркерах.
>
> Не назначение: **кадровый отбор/отсев людей по ДНК**. В шаблоне специально заложены policy‑гейты, чтобы выводы не превращались в дискриминационную практику.

---

## 0) Как это “одной кнопкой” прогоняется в MolecularGPT

В MolecularGPT всё крутится вокруг 3 сущностей:

1. **UnifiedManifest** (что именно запускаем)
2. **Workflow** (какие шаги и в каком порядке)
3. **Artifact Store + Experiment Graph** (куда складываем результаты и как связываем)

Этот шаблон задаёт:

* входные файлы (что нужно положить в `data/`),
* “манифест исследования” (что считается, какие ковариаты, какие запреты),
* схемы событий (чтобы в EG всё ложилось одинаково),
* папки для артефактов (чтобы MARA/MolecularGPT могли обмениваться ссылками),
* тесты и чек‑листы качества.

---

## 1) Дерево папок (строгая структура)

```
Ген Силовика/
  README.md
  LICENSE
  .gitignore

  docs/
    00_scope_and_ethics.md
    01_data_dictionary.md
    02_threat_model.md
    03_metrics_and_acceptance.md
    04_publication_policy.md
    diagrams/
      architecture.mmd
      state_machine.mmd

  config/
    project.json
    environments/
      local.json
      staging.json
      prod.json
    policy/
      policy.yml
      pii_redaction.yml
    thresholds/
      qc_thresholds.yml
      uncertainty_thresholds.yml
      fairness_thresholds.yml

  schemas/
    manifests/
      StudyManifest.schema.json
      CohortDefinitionManifest.schema.json
      ConsentManifest.schema.json
      QCManifest.schema.json
      ModelAuditManifest.schema.json
      ReportManifest.schema.json
    events/
      event.envelope.schema.json
      study.created.schema.json
      qc.completed.schema.json
      analysis.completed.schema.json
      report.published.schema.json

  manifests/
    000_study_manifest.example.json
    010_cohort_definition.example.json
    020_consent_manifest.example.json
    030_qc_manifest.example.json
    040_model_audit_manifest.example.json
    050_report_manifest.example.json

  mara/
    README.md
    tools/
      moleculargpt_tool_contract.md
      tool_input.example.json
      tool_output.example.json
    workflows/
      00_one_button_research.workflow.yml
      01_qc_only.workflow.yml
      02_replication.workflow.yml

  pipelines/
    README.md
    steps/
      00_ingest_data.md
      01_genetic_qc.md
      02_population_structure.md
      03_phenotype_qc.md
      04_association_analysis.md
      05_replication.md
      06_modeling_prs.md
      07_reporting.md

  data/
    README.md
    raw/
      genetics/
        README.md
      phenotypes/
        README.md
      covariates/
        README.md
      provenance/
        README.md
      consents/
        README.md
    processed/
      genetics/
        README.md
      phenotypes/
        README.md
      covariates/
        README.md
      splits/
        README.md

  artifacts/
    README.md
    _staging/
      README.md
    qc/
      README.md
    analysis/
      README.md
    models/
      README.md
    reports/
      README.md
    exports/
      README.md

  eg/
    README.md
    nodes/
      README.md
    edges/
      README.md

  run-ledger/
    README.md
    runs/
      README.md

  scripts/
    README.md
    one_button_run.sh
    validate_manifests.sh
    pack_artifacts.sh

  tests/
    README.md
    contract/
      README.md
    schemas/
      README.md
    integration/
      README.md

  .github/
    workflows/
      ci.yml
```

---

## 2) Содержимое ключевых файлов (пустые, но подробно “раскомментированные”)

Ниже — шаблоны, которые ты копируешь как есть. Они намеренно содержат **много комментариев**, чтобы было понятно, чем заполнять.

> Примечание про комментарии:
>
> * JSON комментарии не поддерживает — поэтому в примерах комментарии сделаны как строки `"__comment": "..."`.
> * В YAML/MD комментарии обычные `#`.

---

### 2.1 `README.md`

```md
# Ген Силовика (Research Kit)

Этот репозиторий — **шаблон исследования** для проверки гипотез о стресс‑реактивности, восстановлении и устойчивости.

## Что делает
- Принимает генетические и фенотипические данные (обезличенные)
- Проводит QC
- Контролирует популяционную структуру (анти‑конфаундинг)
- Выполняет ассоциативный анализ + репликацию
- Генерирует отчёты: неопределённость, ограничения применимости, fairness
- Складывает артефакты в Artifact Store и связывает их в Experiment Graph

## Что НЕ делает
- Не формирует выводы “годен/не годен”
- Не используется как кадровый фильтр

## One‑button запуск
- Заполни `manifests/000_study_manifest.example.json`
- Положи данные в `data/raw/...`
- Запусти `scripts/one_button_run.sh`

См. `docs/00_scope_and_ethics.md`.
```

---

### 2.2 `docs/00_scope_and_ethics.md`

```md
# Scope & Ethics

## Цель
Научно проверить гипотезы о связи **генетических маркеров** (как слабых сигналов) и **фенотипических метрик** (как сильных сигналов)
со стресс‑реактивностью и восстановлением.

## Запрещённые применения
- кадровый отбор/отсев людей по ДНК
- прогнозирование “склонности к насилию” для персональных решений

## Разрешённые применения
- профилактика и поддержка здоровья
- улучшение программ восстановления
- научные публикации с репликацией и ограничениями применимости

## Требования
- Consent + право на отзыв
- Раздельное хранение ключа де‑псевдонимизации
- Uncertainty + fairness отчёты обязательны
```

---

### 2.3 `config/project.json`

```json
{
  "__comment": "Общий конфиг проекта: идентификаторы, где лежат артефакты, какой event bus, какие сервисы включены.",
  "project_id": "gene-silovika",
  "project_name": "Ген Силовика — Research",

  "artifact_store": {
    "__comment": "S3/MinIO. В реальном MolecularGPT это указывает на бакет и префикс.",
    "provider": "minio",
    "bucket": "moleculargpt-artifacts",
    "prefix": "gene-silovika/"
  },

  "event_bus": {
    "__comment": "Kafka/NATS/RabbitMQ. Здесь только заглушка.",
    "provider": "nats",
    "topic_prefix": "gene-silovika"
  },

  "experiment_graph": {
    "__comment": "Где живёт EG: Postgres/Neo4j/… Важно: trace_id = correlation_id.",
    "provider": "postgres",
    "database": "moleculargpt_eg"
  },

  "policy": {
    "__comment": "Какие policy‑гейты включены. Если выключить — CI должен падать.",
    "enforce_no_selection": true,
    "require_uncertainty_report": true,
    "require_fairness_report": true,
    "require_replication": true
  }
}
```

---

### 2.4 `config/policy/policy.yml`

```yml
# Policy gates — центральный файл, который блокирует опасные сценарии.

project:
  name: "Ген Силовика — Research"

forbidden_outputs:
  # НЕЛЬЗЯ генерировать персональные «вердикты пригодности»
  - "fit/unfit"
  - "candidate_rank_for_hiring"
  - "violence_propensity_score_for_individual"

required_reports:
  - "uncertainty_report"
  - "fairness_report"
  - "limitations"
  - "replication_report"

data_rules:
  pii:
    # Идентификаторы людей запрещены
    forbidden_fields:
      - "passport"
      - "full_name"
      - "phone"
      - "address"
    allowed_identifier: "participant_id"  # только псевдоним

release_rules:
  # Публиковать можно только агрегаты и summary stats
  allow_individual_level_exports: false
```

---

### 2.5 `data/README.md`

```md
# Данные (data/)

## Принцип
- В `raw/` кладём **исходники** (обезличенные) + provenance.
- В `processed/` — результаты QC и нормализации.

## Форматы
- genetics:
  - WGS/WES: FASTQ.gz, BAM/CRAM (+ индексы), VCF.gz (+ .tbi)
  - массивы: PLINK (.bed/.bim/.fam или .pgen/.pvar/.psam)
- phenotypes/covariates:
  - TSV/CSV (предпочтительно TSV)

## Важно
- Ключ де‑псевдонимизации НИКОГДА не хранится в репозитории.
```

---

### 2.6 `schemas/events/event.envelope.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "EventEnvelope",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "event_type",
    "schema_version",
    "timestamp",
    "correlation_id",
    "project_id",
    "iteration_id",
    "idempotency_key",
    "artifact_refs",
    "provenance",
    "payload"
  ],
  "properties": {
    "event_type": { "type": "string" },
    "schema_version": { "type": "string" },
    "timestamp": { "type": "string", "format": "date-time" },

    "correlation_id": { "type": "string" },
    "project_id": { "type": "string" },
    "iteration_id": { "type": "string" },

    "idempotency_key": { "type": "string" },

    "artifact_refs": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["uri", "sha256", "media_type"],
        "properties": {
          "uri": { "type": "string" },
          "sha256": { "type": "string" },
          "media_type": { "type": "string" },
          "size_bytes": { "type": "integer" },
          "label": { "type": "string" }
        }
      }
    },

    "provenance": {
      "type": "object",
      "required": ["actor", "tool", "version"],
      "properties": {
        "actor": { "type": "string", "description": "user/service" },
        "tool": { "type": "string", "description": "workflow/model adapter" },
        "version": { "type": "string" },
        "params_hash": { "type": "string" },
        "code_hash": { "type": "string" }
      }
    },

    "payload": { "type": "object" }
  }
}
```

---

### 2.7 `schemas/manifests/StudyManifest.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "StudyManifest",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "manifest_type",
    "schema_version",
    "project_id",
    "iteration_id",
    "correlation_id",
    "study",
    "data_inputs",
    "analysis_plan",
    "policy"
  ],
  "properties": {
    "manifest_type": { "const": "StudyManifest" },
    "schema_version": { "type": "string" },

    "project_id": { "type": "string" },
    "iteration_id": { "type": "string" },
    "correlation_id": { "type": "string" },

    "study": {
      "type": "object",
      "required": ["title", "objective", "allowed_use"],
      "properties": {
        "title": { "type": "string" },
        "objective": { "type": "string", "description": "Формулируется как научная гипотеза, а не кадровый вердикт." },
        "allowed_use": {
          "type": "string",
          "enum": ["health_support", "research_only"],
          "description": "Запрещаем кадровое применение прямо в манифесте."
        },
        "forbidden_use": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "data_inputs": {
      "type": "object",
      "required": ["genetics", "phenotypes", "covariates"],
      "properties": {
        "genetics": { "type": "string", "description": "Путь/URI на набор генотипов (VCF/PLINK)." },
        "phenotypes": { "type": "string", "description": "TSV/CSV с метриками (сон/HRV/реакция/восстановление)." },
        "covariates": { "type": "string", "description": "TSV/CSV: возраст/пол/батч/нагрузка/смены/и т.д." },
        "consent_bundle": { "type": "string", "description": "Ссылка на ConsentManifest (не персональные документы)." }
      }
    },

    "analysis_plan": {
      "type": "object",
      "required": ["qc", "population_structure", "association", "replication", "reports"],
      "properties": {
        "qc": {
          "type": "object",
          "description": "Какие QC шаги включены и пороги (см. config/thresholds)."
        },
        "population_structure": {
          "type": "object",
          "description": "PCA/контроль стратификации — обязателен."
        },
        "association": {
          "type": "object",
          "description": "Регрессии/смешанные модели. Выход — только агрегаты (summary)."
        },
        "replication": {
          "type": "object",
          "description": "Hold-out/внешняя когорта/bootstraps. Без репликации нельзя делать выводы."
        },
        "reports": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["uncertainty", "fairness", "limitations", "replication"]
          }
        }
      }
    },

    "policy": {
      "type": "object",
      "required": ["no_selection", "no_individual_exports"],
      "properties": {
        "no_selection": { "const": true },
        "no_individual_exports": { "const": true },
        "require_two_judges": { "type": "boolean", "default": true }
      }
    }
  }
}
```

---

### 2.8 `manifests/000_study_manifest.example.json`

```json
{
  "__comment": "Заполни этот файл — и это будет входом для one-button запуска.",
  "manifest_type": "StudyManifest",
  "schema_version": "0.1.0",

  "project_id": "gene-silovika",
  "iteration_id": "iter-0001",
  "correlation_id": "corr-CHANGE-ME-UUID",

  "study": {
    "__comment": "Формулируем цель как исследование здоровья/восстановления, не как кадровую пригодность.",
    "title": "Stress Response & Recovery Profile — пилот",
    "objective": "Проверить, какие факторы (сон/нагрузка/генетические варианты) статистически связаны с метриками восстановления.",
    "allowed_use": "health_support",
    "forbidden_use": [
      "hiring_selection",
      "fit_unfit_decisions",
      "individual_violence_prediction"
    ]
  },

  "data_inputs": {
    "__comment": "Указывай НЕ локальные пути, а URI в artifact store (или относительные пути в data/ для локального режима).",
    "genetics": "data/raw/genetics/",
    "phenotypes": "data/raw/phenotypes/phenotypes.tsv",
    "covariates": "data/raw/covariates/covariates.tsv",
    "consent_bundle": "manifests/020_consent_manifest.example.json"
  },

  "analysis_plan": {
    "qc": {
      "__comment": "Пороги лежат в config/thresholds. Здесь можно переопределять.",
      "enabled": true
    },
    "population_structure": {
      "__comment": "PCA/контроль происхождения обязателен.",
      "enabled": true
    },
    "association": {
      "__comment": "Только агрегированные результаты (summary stats).",
      "enabled": true,
      "model": "linear_or_mixed"
    },
    "replication": {
      "__comment": "Без репликации — только exploratory отчёт.",
      "enabled": true,
      "strategy": "holdout"
    },
    "reports": ["uncertainty", "fairness", "limitations", "replication"]
  },

  "policy": {
    "no_selection": true,
    "no_individual_exports": true,
    "require_two_judges": true
  }
}
```

---

### 2.9 `mara/workflows/00_one_button_research.workflow.yml`

```yml
# Это “логика одной кнопки” для Nanome MARA.
# MARA запускает этот workflow, который вызывает MolecularGPT как Tool Provider.
# Внутри MolecularGPT это превращается в запуск Workflow Orchestrator (Temporal/Argo).

name: one_button_gene_silovika_research
version: 0.1.0

inputs:
  # StudyManifest — главный вход
  study_manifest_uri:
    type: string
    description: "URI на manifests/000_study_manifest.example.json (или на его копию в S3/MinIO)"

steps:
  - id: validate_manifest
    tool: moleculargpt.validate_manifest
    with:
      uri: ${inputs.study_manifest_uri}

  - id: ingest_data
    tool: moleculargpt.ingest
    with:
      study_manifest_uri: ${inputs.study_manifest_uri}

  - id: genetic_qc
    tool: moleculargpt.qc.genetics
    with:
      study_manifest_uri: ${inputs.study_manifest_uri}

  - id: population_structure
    tool: moleculargpt.analysis.pca
    with:
      study_manifest_uri: ${inputs.study_manifest_uri}

  - id: phenotype_qc
    tool: moleculargpt.qc.phenotypes
    with:
      study_manifest_uri: ${inputs.study_manifest_uri}

  - id: association
    tool: moleculargpt.analysis.association
    with:
      study_manifest_uri: ${inputs.study_manifest_uri}

  - id: replication
    tool: moleculargpt.analysis.replication
    with:
      study_manifest_uri: ${inputs.study_manifest_uri}

  - id: reports
    tool: moleculargpt.reporting.bundle
    with:
      study_manifest_uri: ${inputs.study_manifest_uri}
      reports:
        - uncertainty
        - fairness
        - limitations
        - replication

outputs:
  artifact_bundle_uri:
    type: string
    description: "Ссылка на собранный bundle артефактов (S3/MinIO)"

notes:
  - "Любой шаг обязан писать EventEnvelope в Event Bus и узлы в Experiment Graph."
  - "Если policy нарушен (no_selection/no_individual_exports) — workflow должен падать."
```

---

### 2.10 `scripts/one_button_run.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# one_button_run.sh
#
# Это “локальный” фасад для запуска того же пайплайна, который в проде оркестрирует MARA/Workflow Engine.
#
# Здесь НЕТ реальной реализации — это шаблон, который ты подключишь к своему MolecularGPT CLI.
#
# Что должно происходить:
# 1) Валидация манифеста по JSON‑schema
# 2) Policy‑проверки (запрет селекции, запрет индивидуальных экспортов)
# 3) Запуск workflow: QC → PCA → Association → Replication → Reports
# 4) Складирование артефактов в artifacts/ и/или в S3/MinIO
# 5) Запись событий и графа (EG + Run Ledger)
# ─────────────────────────────────────────────────────────────────────────────

MANIFEST=${1:-manifests/000_study_manifest.example.json}

echo "[one-button] manifest = ${MANIFEST}"

# TODO: заменить на реальную команду MolecularGPT CLI, например:
# moleculargpt run --manifest "$MANIFEST" --profile local

echo "[one-button] TODO: integrate with MolecularGPT CLI"

# Пример ожидаемых выходов (после интеграции):
# - artifacts/qc/... (qc отчёты)
# - artifacts/analysis/... (summary stats)
# - artifacts/reports/... (uncertainty/fairness/limitations)
# - eg/nodes + eg/edges (дампы для отладки)
# - run-ledger/runs/... (версии/хэши/параметры)
```

---

## 3) Что именно должно появляться в `artifacts/` (конвенции)

### 3.1 `artifacts/qc/`

* `genetics_qc.json` — пороги, исключения, метрики
* `phenotype_qc.json` — пропуски, выбросы, батчи
* `exclusions.tsv` — список исключённых `participant_id` (без причин персонального характера)

### 3.2 `artifacts/analysis/`

* `pca.tsv` — координаты PCA (для контроля стратификации)
* `association_summary.tsv.gz` — агрегированные summary stats
* `replication_summary.tsv.gz` — агрегированные результаты репликации

### 3.3 `artifacts/reports/`

* `uncertainty_report.md`
* `fairness_report.md`
* `limitations.md`
* `replication_report.md`

### 3.4 `artifacts/exports/`

* `public_bundle.zip` — только агрегаты и отчёты (никаких индивидуальных данных)

---

## 4) Минимальные тесты, которые должны быть зелёными

`tests/contract/`:

* событие соответствует `schemas/events/event.envelope.schema.json`
* каждый manifest соответствует своему schema

`tests/integration/`:

* без `uncertainty_report` релиз запрещён
* без `fairness_report` релиз запрещён
* без `replication` релиз запрещён (или метка `exploratory_only`)

---

## 5) Что дальше (после того как шаблон заполнится)

1. Встроить в MolecularGPT:

   * `validate_manifest`
   * `ingest`
   * `qc.genetics`, `analysis.pca`, `analysis.association`, `analysis.replication`
   * `reporting.bundle`

2. Подключить MARA:

   * `mara-bridge` inbound (MARA вызывает MolecularGPT)
   * `mara-client` outbound (MolecularGPT вызывает MARA) — по мере надобности

3. Подключить Nanome XR (опционально):

   * публиковать структуры/результаты как визуальные артефакты

---

Если хочешь, следующим шагом я:

* допишу **конкретные JSON‑schema** для `QCManifest`, `ModelAuditManifest`, `ReportManifest` (с максимальными полями),
* добавлю `docs/diagrams/*.mmd` (архитектура и state‑machine) готовыми,
* и сделаю **скелет CI** (`.github/workflows/ci.yml`), который валит PR, если нарушен policy или схемы.
